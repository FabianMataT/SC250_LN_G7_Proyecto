{% extends 'base.html' %}

{% block title %}An치lisis de Datos{% endblock %}

{% block content %}
<div class="justify-center">
  <div class="mt-6 bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl border border-teal-fresh/30 p-8 w-[900px]">
    <h1 class="text-2xl font-extrabold text-cyan-500 text-center">
      An치lisis de Datos con Inteligencia Artificial
    </h1>

    <section class="w-full mt-6 px-6">
      <h2 class="text-1xl font-extrabold mb-12 text-center select-none">
        T칠cnicas de Inteligencia Artificial Aplicadas
      </h2>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-12">
        <!-- Clustering -->
        <div
          class="bg-indigo-50 p-8 rounded-3xl shadow-lg border border-indigo-200 hover:shadow-xl transition-shadow duration-300"
          tabindex="0" aria-label="Clustering - Agrupar datos similares">
          <div class="text-indigo-700 text-4xl mb-6 text-center select-none" aria-hidden="true">游늵</div>
          <h3 class="text-xl font-bold text-indigo-900 mb-4 text-center">Clustering</h3>
          <p class="text-indigo-800 leading-relaxed text-center">
            Agrupamos datos similares para descubrir patrones y segmentar tu informaci칩n.<br />
            <span class="font-semibold">Ejemplos:</span> K-means, DBSCAN
          </p>
        </div>

        <!-- Detecci칩n de Outliers -->
        <div
          class="bg-indigo-50 p-8 rounded-3xl shadow-lg border border-indigo-200 hover:shadow-xl transition-shadow duration-300"
          tabindex="0" aria-label="Detecci칩n de outliers - Identificar valores at칤picos">
          <div class="text-indigo-700 text-4xl mb-6 text-center select-none" aria-hidden="true">游뛀</div>
          <h3 class="text-xl font-bold text-indigo-900 mb-4 text-center">Detecci칩n de Outliers</h3>
          <p class="text-indigo-800 leading-relaxed text-center">
            Identificamos valores at칤picos que pueden indicar errores o eventos importantes.<br />
            <span class="font-semibold">M칠todos:</span> Z-score, IQR, Isolation Forest
          </p>
        </div>

        <!-- An치lisis de Correlaciones -->
        <div
          class="bg-indigo-50 p-8 rounded-3xl shadow-lg border border-indigo-200 hover:shadow-xl transition-shadow duration-300"
          tabindex="0" aria-label="An치lisis de correlaciones - Explorar relaciones entre variables">
          <div class="text-indigo-700 text-4xl mb-6 text-center select-none" aria-hidden="true">游댕</div>
          <h3 class="text-xl font-bold text-indigo-900 mb-4 text-center">An치lisis de Correlaciones</h3>
          <p class="text-indigo-800 leading-relaxed text-center">
            Exploramos relaciones entre variables para entender dependencias y tendencias.
          </p>
        </div>
      </div>
    </section>
  </div>

  <!-- Resultados: Clustering, Outliers, etc -->
  {% for res in resultados %}
  <section
    class="mt-6 bg-white/90 backdrop-blur-sm rounded-2xl shadow-xl border border-teal-fresh/30 p-8 w-[900px] mx-auto text-center">
    <h2 class="text-teal-700 font-semibold text-3xl mb-6">{{ res.filename }}</h2>

    {% if res.analisis.numeric_columns %}
    <form class="scatterForm flex flex-wrap justify-center items-end gap-4 mb-6" method="POST" action="/scatter">
      <input type="hidden" name="file_id" value="{{ res.file_id }}">

      <div class="flex flex-col max-h-40 overflow-y-auto">
        <label for="x_column" class="font-medium mb-1">Eje X:</label>
        <select name="x_column" class="border border-gray-300 rounded px-2 py-1">
          {% for col in res.analisis.numeric_columns %}
          <option value="{{ col }}" {% if loop.index0==0 %}selected{% endif %}>{{ col }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="flex flex-col max-h-40 overflow-y-auto">
        <label for="y_column" class="font-medium mb-1">Eje Y:</label>
        <select name="y_column" class="border border-gray-300 rounded px-2 py-1">
          {% for col in res.analisis.numeric_columns %}
          <option value="{{ col }}" {% if loop.index0==1 %}selected{% endif %}>{{ col }}</option>
          {% endfor %}
        </select>
      </div>

      <button type="submit" class="bg-cyan-500 text-white font-semibold px-4 py-2 rounded hover:bg-cyan-600 transition">
        Generar Gr치fico
      </button>
    </form>

    <div class="scatterContainer border border-gray-200 rounded p-4 bg-gray-50 mx-auto" style="max-width: 700px;"></div>

    <img src="data:image/png;base64,{{ res.boxplot_img }}" alt="Boxplot" class="mt-6 max-w-full rounded mx-auto" />

    {% endif %}

    <div class="mt-10 grid grid-cols-1 md:grid-cols-3 gap-12">
      {% if res.clustering_kmeans_labels %}
      <div class="w-full">
        <h3 class="font-semibold mb-2">Clustering K-Means</h3>
        <div class="max-h-48 overflow-y-auto border border-gray-200 rounded p-2 bg-gray-50">
          <ul>
            {% for label in res.clustering_kmeans_labels %}
            <li>{{ label }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}

      {% if res.clustering_dbscan_labels %}
      <div class="w-full">
        <h3 class="font-semibold mb-2">Clustering DBSCAN</h3>
        <div class="max-h-48 overflow-y-auto border border-gray-200 rounded p-2 bg-gray-50">
          <ul>
            {% for label in res.clustering_dbscan_labels %}
            <li>{{ label }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}

      {% if res.status_zscore %}
      <div class="w-full">
        <h3 class="font-semibold mb-2">Outliers Z-Score</h3>
        <div class="max-h-48 overflow-y-auto border border-gray-200 rounded p-2 bg-gray-50">
          <ul>
            {% for stat in res.status_zscore %}
            <li>Fila {{ loop.index }}: {{ stat }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% endif %}
    </div>

    {% if res.plot_img %}
    <h3 class="mt-10 font-semibold">Matriz de Correlaci칩n</h3>
    <img src="data:image/png;base64,{{ res.plot_img }}" alt="Heatmap" class="max-w-full rounded mx-auto" />
    {% endif %}
  </section>
  {% endfor %}
</div>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector(".scatterForm");
    const container = form.nextElementSibling;

    // Funci칩n para generar el scatter plot inicial
    const generateInitialPlot = () => {
      const formData = new FormData(form);
      fetch("/scatter", {
        method: "POST",
        body: formData
      })
        .then(res => res.json())
        .then(data => {
          if (data.scatter_plot) {
            container.innerHTML = `<img src="data:image/png;base64,${data.scatter_plot}" alt="Scatter Plot">`;
          } else {
            container.innerHTML = `<p style="color:red;">${data.error}</p>`;
          }
        });
    };

    generateInitialPlot(); // Genera el scatter al cargar la p치gina

    // Re-generar cuando se cambian columnas
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      generateInitialPlot();
    });
  });
</script>

<script>
  document.querySelectorAll(".graphicsTypeForm").forEach(form => {
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const container = this.nextElementSibling;

      fetch("/graphics_types", {
        method: "POST",
        body: formData
      })
        .then(res => res.json())
        .then(data => {
          if (data.graph) {
            container.innerHTML = `<img src="data:image/png;base64,${data.graph}" alt="Gr치fico">`;
          } else {
            container.innerHTML = `<p style="color:red;">${data.error}</p>`;
          }
        });
    });
  });
</script>

<script>
  document.querySelectorAll(".scatterForm").forEach(form => {
    form.addEventListener("submit", function (e) {
      e.preventDefault();
      const formData = new FormData(this);
      const container = this.nextElementSibling;

      fetch("/scatter", {
        method: "POST",
        body: formData
      })
        .then(res => res.json())
        .then(data => {
          if (data.scatter_plot) {
            container.innerHTML = `<img src="data:image/png;base64,${data.scatter_plot}" alt="Scatter Plot">`;
          } else {
            container.innerHTML = `<p style="color:red;">${data.error}</p>`;
          }
        });
    });
  });
</script>
{% endblock %}